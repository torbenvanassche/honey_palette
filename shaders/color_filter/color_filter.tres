[gd_resource type="Shader" format=3 uid="uid://clgt0a45gbdju"]

[resource]
code = "shader_type spatial;
render_mode depth_prepass_alpha, cull_back, blend_mix;

uniform vec4 color_tint: source_color = vec4(1, 1, 1, 1);
uniform sampler2D albedo_texture : source_color;
uniform sampler2D emission_texture : source_color;
uniform sampler2D normal_texture : hint_normal;
uniform bool force_texture =  false;
uniform bool use_emission = false;
uniform bool tint_as_emission = false;

uniform vec4 filter_colors[64];
uniform int palette_size = 64;

const vec4 fallback_color = vec4(0.3, 0.3, 0.3, 1.0);
uniform float COLOR_THRESHOLD = 0.05;

bool is_allowed(vec4 color) {
    for (int i = 0; i < palette_size; i++) {
        if (distance(color.rgb, filter_colors[i].rgb) < COLOR_THRESHOLD) {
            return true;
        }
    }
    return false;
}

void fragment() {
    vec4 tex_color = texture(albedo_texture, UV);

    if (is_allowed(tex_color) || force_texture) {
        ALBEDO = tex_color.rgb * color_tint.rgb;
        ALPHA = tex_color.a * color_tint.a;
    } else {
        ALBEDO = fallback_color.rgb;
        ALPHA = fallback_color.a;
    }

	NORMAL_MAP = texture(normal_texture, UV).xyz;

	if (use_emission) {
		vec3 emission = texture(emission_texture, UV).rgb;
		if (tint_as_emission) {
			emission =  color_tint.rgb;
		}
    	EMISSION = emission;
	}
}"
